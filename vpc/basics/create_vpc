#!/usr/bin/env bash

REGION="us-east-2"
CIDR_BLOCK="10.2.0.0/16"
VPC_NAME="my_VPC"
PUBLIC_SUBNET_CIDR="10.2.1.0/24"
PRIVATE_SUBNET_CIDR="10.2.2.0/24"

# Create VPC
echo "üîß Creating VPC..."
aws ec2 create-vpc \
  --cidr-block "$CIDR_BLOCK" \
  --region $REGION \
  --tag-specifications "ResourceType=vpc,Tags=[{Key=Name,Value=$VPC_NAME}]" \
  --output json > vpc_output.json

# Extract VPC ID
VPC_ID=$(jq -r '.Vpc.VpcId' vpc_output.json)
echo "‚úÖ Created VPC with ID: $VPC_ID"

echo "üîß Creating Internet Gateway"
IGW_ID=$(aws ec2 create-internet-gateway --region $REGION --output json | jq -r '.InternetGateway.InternetGatewayId')
echo "‚úÖ Created IGW with ID: $IGW_ID"

echo "üîó Attaching IGW to VPC"
aws ec2 attach-internet-gateway \
  --internet-gateway-id $IGW_ID \
  --vpc-id $VPC_ID \
  --region $REGION
echo "‚úÖ IGW $IGW_ID attached to VPC $VPC_ID"



echo "üè∑Ô∏è Tagging IGW with Name: $VPC_NAME"
aws ec2 create-tags \
  --resources $IGW_ID \
  --tags Key=Name,Value=$VPC_NAME \
  --region $REGION
echo "‚úÖ Tagged IGW $IGW_ID with Name: $VPC_NAME"


#  create two subnets in different AZs: private and public subnets

echo "Creating Public Subnet"
PUBLIC_SUBNET_ID=$(aws ec2 create-subnet \
  --vpc-id $VPC_ID \
  --cidr-block $PUBLIC_SUBNET_CIDR \
  --availability-zone ${REGION}a \
  --output json | jq -r '.Subnet.SubnetId')
echo "‚úÖ Created Public Subnet with ID: $PUBLIC_SUBNET_ID"

echo "Creating Private Subnet"
PRIVATE_SUBNET_ID=$(aws ec2 create-subnet \
  --vpc-id $VPC_ID \
  --cidr-block $PRIVATE_SUBNET_CIDR \
  --availability-zone ${REGION}b \
  --output json | jq -r '.Subnet.SubnetId')
echo "‚úÖ Created Private Subnet with ID: $PRIVATE_SUBNET_ID"


# Enable auto-assign public IP on public subnet
echo "üîß Enabling auto-assign public IP on Public Subnet"
aws ec2 modify-subnet-attribute \
  --subnet-id $PUBLIC_SUBNET_ID \
  --map-public-ip-on-launch
echo "‚úÖ Public IP auto-assignment enabled"

# Tag subnets
echo "üè∑Ô∏è Tagging Subnets"
aws ec2 create-tags \
  --resources $PUBLIC_SUBNET_ID \
  --tags Key=Name,Value=Public-Subnet \
  --region $REGION

aws ec2 create-tags \
  --resources $PRIVATE_SUBNET_ID \
  --tags Key=Name,Value=Private-Subnet \
  --region $REGION
echo "‚úÖ Tagged Public and Private Subnets"
